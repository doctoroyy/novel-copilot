name: Build Mobile Packages

on:
  workflow_dispatch:
  push:
    branches:
      - main
    paths:
      - .github/workflows/build-mobile-packages.yml
      - package.json
      - scripts/**
      - mobile/**

permissions:
  contents: write

env:
  APP_NAME: NovelCopilot

concurrency:
  group: build-mobile-packages-${{ github.ref }}
  cancel-in-progress: true

jobs:
  android-packages:
    name: Android (universal + arm64)
    runs-on: ubuntu-latest
    timeout-minutes: 50
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Java
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: "17"

      - name: Setup pnpm
        uses: pnpm/action-setup@v4
        with:
          version: "9"

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "22"
          cache: pnpm
          cache-dependency-path: |
            pnpm-lock.yaml
            mobile/pnpm-lock.yaml

      - name: Install root dependencies
        run: pnpm install --frozen-lockfile

      - name: Install mobile dependencies
        run: pnpm -C mobile install --frozen-lockfile

      - name: Generate Android native project
        env:
          CI: "1"
        run: pnpm -C mobile exec expo prebuild --platform android --no-install

      - name: Enable ABI splits
        run: bash ./scripts/android-enable-abi-splits.sh

      - name: Build release APKs
        run: |
          cd mobile/android
          chmod +x ./gradlew
          ./gradlew :app:assembleRelease --no-daemon

      - name: Prepare named APK outputs
        run: |
          mkdir -p release-assets
          cp mobile/android/app/build/outputs/apk/release/app-universal-release.apk release-assets/${APP_NAME}-android-universal.apk
          cp mobile/android/app/build/outputs/apk/release/app-arm64-v8a-release.apk release-assets/${APP_NAME}-android-arm64-v8a.apk
          ls -lah release-assets

      - name: Upload universal APK artifact
        uses: actions/upload-artifact@v4
        with:
          name: ${{ env.APP_NAME }}-android-universal-apk
          path: release-assets/${{ env.APP_NAME }}-android-universal.apk
          if-no-files-found: error

      - name: Upload arm64 APK artifact
        uses: actions/upload-artifact@v4
        with:
          name: ${{ env.APP_NAME }}-android-arm64-apk
          path: release-assets/${{ env.APP_NAME }}-android-arm64-v8a.apk
          if-no-files-found: error

  ios-package:
    name: iOS IPA
    runs-on: macos-15
    timeout-minutes: 70
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Check iOS signing secrets
        id: ios_secrets
        env:
          IOS_CERT_BASE64: ${{ secrets.IOS_CERT_BASE64 }}
          IOS_CERT_PASSWORD: ${{ secrets.IOS_CERT_PASSWORD }}
          IOS_PROVISION_PROFILE_BASE64: ${{ secrets.IOS_PROVISION_PROFILE_BASE64 }}
          IOS_TEAM_ID: ${{ secrets.IOS_TEAM_ID }}
          IOS_KEYCHAIN_PASSWORD: ${{ secrets.IOS_KEYCHAIN_PASSWORD }}
        run: |
          missing=0
          for key in IOS_CERT_BASE64 IOS_CERT_PASSWORD IOS_PROVISION_PROFILE_BASE64 IOS_TEAM_ID IOS_KEYCHAIN_PASSWORD; do
            if [ -z "${!key}" ]; then
              echo "[warn] missing required secret: $key"
              missing=1
            fi
          done

          if [ "$missing" -eq 1 ]; then
            echo "ready=false" >> "$GITHUB_OUTPUT"
          else
            echo "ready=true" >> "$GITHUB_OUTPUT"
          fi

      - name: Skip iOS build (secrets missing)
        if: ${{ steps.ios_secrets.outputs.ready != 'true' }}
        run: |
          echo "Skipping iOS build because required signing secrets are not set."
          echo "Required secrets: IOS_CERT_BASE64, IOS_CERT_PASSWORD, IOS_PROVISION_PROFILE_BASE64, IOS_TEAM_ID, IOS_KEYCHAIN_PASSWORD."

      - name: Setup pnpm
        if: ${{ steps.ios_secrets.outputs.ready == 'true' }}
        uses: pnpm/action-setup@v4
        with:
          version: "9"

      - name: Setup Node.js
        if: ${{ steps.ios_secrets.outputs.ready == 'true' }}
        uses: actions/setup-node@v4
        with:
          node-version: "22"
          cache: pnpm
          cache-dependency-path: |
            pnpm-lock.yaml
            mobile/pnpm-lock.yaml

      - name: Install root dependencies
        if: ${{ steps.ios_secrets.outputs.ready == 'true' }}
        run: pnpm install --frozen-lockfile

      - name: Install mobile dependencies
        if: ${{ steps.ios_secrets.outputs.ready == 'true' }}
        run: pnpm -C mobile install --frozen-lockfile

      - name: Install CocoaPods dependencies
        if: ${{ steps.ios_secrets.outputs.ready == 'true' }}
        run: cd mobile/ios && pod install

      - name: Configure signing assets
        if: ${{ steps.ios_secrets.outputs.ready == 'true' }}
        id: signing
        env:
          IOS_CERT_BASE64: ${{ secrets.IOS_CERT_BASE64 }}
          IOS_CERT_PASSWORD: ${{ secrets.IOS_CERT_PASSWORD }}
          IOS_PROVISION_PROFILE_BASE64: ${{ secrets.IOS_PROVISION_PROFILE_BASE64 }}
          IOS_KEYCHAIN_PASSWORD: ${{ secrets.IOS_KEYCHAIN_PASSWORD }}
        run: |
          CERTIFICATE_PATH="$RUNNER_TEMP/signing-cert.p12"
          PROFILE_PATH="$RUNNER_TEMP/profile.mobileprovision"
          PROFILE_PLIST="$RUNNER_TEMP/profile.plist"
          KEYCHAIN_PATH="$RUNNER_TEMP/build-signing.keychain-db"

          echo "$IOS_CERT_BASE64" | base64 --decode > "$CERTIFICATE_PATH"
          echo "$IOS_PROVISION_PROFILE_BASE64" | base64 --decode > "$PROFILE_PATH"

          security create-keychain -p "$IOS_KEYCHAIN_PASSWORD" "$KEYCHAIN_PATH"
          security set-keychain-settings -lut 21600 "$KEYCHAIN_PATH"
          security unlock-keychain -p "$IOS_KEYCHAIN_PASSWORD" "$KEYCHAIN_PATH"
          security list-keychain -d user -s "$KEYCHAIN_PATH"
          security import "$CERTIFICATE_PATH" -P "$IOS_CERT_PASSWORD" -A -t cert -f pkcs12 -k "$KEYCHAIN_PATH"
          security set-key-partition-list -S apple-tool:,apple: -s -k "$IOS_KEYCHAIN_PASSWORD" "$KEYCHAIN_PATH"

          security cms -D -i "$PROFILE_PATH" > "$PROFILE_PLIST"
          PROFILE_UUID="$(/usr/libexec/PlistBuddy -c "Print UUID" "$PROFILE_PLIST")"
          PROFILE_NAME="$(/usr/libexec/PlistBuddy -c "Print Name" "$PROFILE_PLIST")"

          mkdir -p "$HOME/Library/MobileDevice/Provisioning Profiles"
          cp "$PROFILE_PATH" "$HOME/Library/MobileDevice/Provisioning Profiles/$PROFILE_UUID.mobileprovision"

          echo "profile_name=$PROFILE_NAME" >> "$GITHUB_OUTPUT"

      - name: Build and export IPA
        if: ${{ steps.ios_secrets.outputs.ready == 'true' }}
        id: build_ios
        env:
          IOS_TEAM_ID: ${{ secrets.IOS_TEAM_ID }}
          IOS_BUNDLE_ID: ${{ secrets.IOS_BUNDLE_ID }}
          IOS_EXPORT_METHOD: ${{ secrets.IOS_EXPORT_METHOD }}
          IOS_CODE_SIGN_IDENTITY: ${{ secrets.IOS_CODE_SIGN_IDENTITY }}
        run: |
          TEAM_ID="${IOS_TEAM_ID:?IOS_TEAM_ID is required}"
          BUNDLE_ID="${IOS_BUNDLE_ID:-com.xiaoyu.novelcopilot.mobile}"
          METHOD="${IOS_EXPORT_METHOD:-ad-hoc}"
          CODE_SIGN_IDENTITY="${IOS_CODE_SIGN_IDENTITY:-Apple Distribution}"

          TEAM_ID="$TEAM_ID" \
          BUNDLE_ID="$BUNDLE_ID" \
          METHOD="$METHOD" \
          SIGNING_STYLE="manual" \
          CODE_SIGN_IDENTITY="$CODE_SIGN_IDENTITY" \
          PROVISIONING_PROFILE_SPECIFIER="${{ steps.signing.outputs.profile_name }}" \
          pnpm mobile:ios:package

          IPA_PATH="$(ls -t /tmp/NovelCopilot-export-*/NovelCopilot.ipa 2>/dev/null | head -n 1)"
          test -f "$IPA_PATH"

          RENAMED_IPA_PATH="$RUNNER_TEMP/${APP_NAME}-ios.ipa"
          cp "$IPA_PATH" "$RENAMED_IPA_PATH"

          echo "ipa_path=$RENAMED_IPA_PATH" >> "$GITHUB_OUTPUT"

      - name: Upload IPA artifact
        if: ${{ steps.ios_secrets.outputs.ready == 'true' }}
        uses: actions/upload-artifact@v4
        with:
          name: ${{ env.APP_NAME }}-ios-ipa
          path: ${{ steps.build_ios.outputs.ipa_path }}
          if-no-files-found: error

      - name: Cleanup temporary keychain
        if: ${{ always() && steps.ios_secrets.outputs.ready == 'true' }}
        run: security delete-keychain "$RUNNER_TEMP/build-signing.keychain-db" || true

  publish-release-assets:
    name: Publish Release Assets
    runs-on: ubuntu-latest
    needs:
      - android-packages
      - ios-package
    if: ${{ always() }}
    steps:
      - name: Create release-assets directory
        run: mkdir -p release-assets

      - name: Download Android universal artifact
        continue-on-error: true
        uses: actions/download-artifact@v4
        with:
          name: ${{ env.APP_NAME }}-android-universal-apk
          path: release-assets

      - name: Download Android arm64 artifact
        continue-on-error: true
        uses: actions/download-artifact@v4
        with:
          name: ${{ env.APP_NAME }}-android-arm64-apk
          path: release-assets

      - name: Download iOS IPA artifact (optional)
        continue-on-error: true
        uses: actions/download-artifact@v4
        with:
          name: ${{ env.APP_NAME }}-ios-ipa
          path: release-assets

      - name: Verify release assets
        id: verify_assets
        run: |
          ls -lah release-assets
          apk_count=$(find release-assets -maxdepth 1 -type f -name '*.apk' | wc -l | tr -d ' ')
          ipa_count=$(find release-assets -maxdepth 1 -type f -name '*.ipa' | wc -l | tr -d ' ')
          total_count=$((apk_count + ipa_count))
          echo "apk_count=$apk_count" >> "$GITHUB_OUTPUT"
          echo "ipa_count=$ipa_count" >> "$GITHUB_OUTPUT"
          echo "total_count=$total_count" >> "$GITHUB_OUTPUT"
          if [ "$total_count" -gt 0 ]; then
            echo "has_assets=true" >> "$GITHUB_OUTPUT"
          else
            echo "has_assets=false" >> "$GITHUB_OUTPUT"
          fi

      - name: Publish to GitHub Release (rolling)
        if: ${{ steps.verify_assets.outputs.has_assets == 'true' }}
        uses: softprops/action-gh-release@v2
        with:
          tag_name: mobile-builds
          name: NovelCopilot Mobile Builds
          body: |
            Auto-updated mobile build assets.
            - Run: #${{ github.run_number }}
            - Commit: ${{ github.sha }}
          prerelease: true
          make_latest: false
          target_commitish: ${{ github.sha }}
          overwrite_files: true
          files: |
            release-assets/*.apk
            release-assets/*.ipa

      - name: Skip release publish (no assets)
        if: ${{ steps.verify_assets.outputs.has_assets != 'true' }}
        run: echo "No APK/IPA artifacts found in this run, skipping GitHub Release publish."
