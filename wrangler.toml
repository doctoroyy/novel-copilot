name = "novel-copilot"
main = "src/worker.ts"
compatibility_date = "2024-12-01"
compatibility_flags = ["nodejs_compat", "no_handle_cross_request_promise_resolution"]


# D1 Database
[[d1_databases]]
binding = "DB"
database_name = "novel-copilot-db"
database_id = "bf1b57ae-c545-4a1f-b791-cf76bcc968f3"
migrations_dir = "migrations"

# Queue Producer (for sending tasks)
[[queues.producers]]
binding = "GENERATION_QUEUE"
queue = "novel-copilot-generation-queue"

# Queue Consumer (for executing tasks in background)
[[queues.consumers]]
queue = "novel-copilot-generation-queue"
max_batch_size = 1 # Only process 1 generation task at a time per worker instance
max_retries = 3 # Retry up to 3 times on failure
max_concurrency = 5 # Prevent too many concurrent LLM calls bursting


# Development settings
[dev]
port = 8787

# Build frontend before deploy
[build]
command = "cd web && pnpm install && pnpm build"

# Assets (frontend)
[assets]
directory = "./web/dist"
not_found_handling = "single-page-application"
run_worker_first = ["/api/*"]

# R2 Object Storage for anime videos
[[r2_buckets]]
binding = "ANIME_VIDEOS"
bucket_name = "novel-copilot-videos"


